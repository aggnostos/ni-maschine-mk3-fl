# name=NI Maschine MK3 by Aggnostos


# ------------------------------------------------------------------------- #
#  THIS FILE IS AUTO-GENERATED                                              #
#  DO NOT EDIT THIS FILE MANUALLY.                                          #
#                                                                           #
#  Any changes made to this file will be overwritten.                       #
# ------------------------------------------------------------------------- #


import ui
import midi
import mixer
import device
import plugins
import channels
import transport
from enum import Enum


"""Maschine MK3 LED Colors"""

Black0 = 0
Black1 = 1
Black2 = 2
Black3 = 3
Red0 = 4
Red1 = 5
Red2 = 6
Red3 = 7
Orange0 = 8
Orange1 = 9
Orange2 = 10
Orange3 = 11
LightOrange0 = 12
LightOrange1 = 13
LightOrange2 = 14
LightOrange3 = 15
WarmYellow0 = 16
WarmYellow1 = 17
WarmYellow2 = 18
WarmYellow3 = 19
Yellow0 = 20
Yellow1 = 21
Yellow2 = 22
Yellow3 = 23
Lime0 = 24
Lime1 = 25
Lime2 = 26
Lime3 = 27
Green0 = 28
Green1 = 29
Green2 = 30
Green3 = 31
Mint0 = 32
Mint1 = 33
Mint2 = 34
Mint3 = 35
Cyan0 = 36
Cyan1 = 37
Cyan2 = 38
Cyan3 = 39
Turquoise0 = 40
Turquoise1 = 41
Turquoise2 = 42
Turquoise3 = 43
Blue0 = 44
Blue1 = 45
Blue2 = 46
Blue3 = 47
Plum0 = 48
Plum1 = 49
Plum2 = 50
Plum3 = 51
Violet0 = 52
Violet1 = 53
Violet2 = 54
Violet3 = 55
Purple0 = 56
Purple1 = 57
Purple2 = 58
Purple3 = 59
Magenta0 = 60
Magenta1 = 61
Magenta2 = 62
Magenta3 = 63
Fuchsia0 = 64
Fuchsia1 = 65
Fuchsia2 = 66
Fuchsia3 = 67
White0 = 68
White1 = 69
White2 = 70
White3 = 71
"""Maschine MK3 Control Change (CC) Numbers"""

# -------- CONTROL BUTTONS SECTION -------- #
CC_CHANNEL = 34
CC_PLUGIN = 35
CC_ARRANGER = 36
CC_MIXER = 37
CC_BROWSER = 38
CC_SAMPLING = 39
CC_FILE_SAVE = 40
CC_SETTINGS = 41
CC_MACRO_SET = 43


# -------- EDIT (ENCODER) SECTION -------- #
CC_ENCODER_PUSH = 7
CC_ENCODER_TURN = 8
CC_ENCODER_UP = 30
CC_ENCODER_RIGHT = 31
CC_ENCODER_DOWN = 32
CC_ENCODER_LEFT = 33

CC_ENCODER_VOLUME = 44
CC_ENCODER_SWING = 45
CC_ENCODER_TEMPO = 47

# -------- TOUCH STRIP SECTION -------- #
CC_TOUCH_STRIP = 1

CC_LOCK = 48
CC_PITCH = 49
CC_MOD = 50
CC_PERFORM = 51
CC_NOTES = 52

# -------- GROUP SECTION -------- #
CC_PAD_GROUP_A = 100
CC_PAD_GROUP_B = 101
CC_PAD_GROUP_C = 102
CC_PAD_GROUP_D = 103
CC_PAD_GROUP_E = 104
CC_PAD_GROUP_F = 105
CC_PAD_GROUP_G = 106
CC_PAD_GROUP_H = 107

# -------- TRANSPORT SECTION -------- #
CC_RESTART = CC_LOOP = 53
CC_ERASE = 54
CC_TAP = 55
CC_FOLLOW = 56
CC_PLAY = 57
CC_REC = 58
CC_STOP = 59

# -------- PAD SECTION -------- #
CC_FIXED_VEL = 80

# Pad Modes
CC_PAD_MODE = 81
CC_KEYBOARD_MODE = 82
CC_STEP_MODE = 83
CC_CHORDS_MODE = 84

CC_SCENE = 85
CC_PATTERN = 86
CC_EVENTS = 87
CC_VARIATION = 88
CC_DUPLICATE = 89
CC_SELECT = 90
CC_SOLO = 91
CC_MUTE = 92

# ---- KNOB PAGE SECTION ---- #
CC_OCTAVE_DOWN = 26
CC_OCTAVE_UP = 27
CC_SEMI_DOWN = 28
CC_SEMI_UP = 29

CC_MIX_TRACK = 70
CC_MIX_VOLUME = 71
CC_MIX_PAN = 72
CC_MIX_STEREO = 73
CC_CHAN_SEL = 74
CC_CHAN_VOL = 75
CC_CHAN_PAN = 76
CC_FIX_VEL = 77


# -------- Plugin and channel colors for OMNI/PAD modes, feel free to change these with any others from the list --------
class PluginColors(Enum):
    """Plugin Colors"""

    DEFAULT = Green1
    HIGHLIGHTED = Green3


class ChannelColors(Enum):
    """Channel Colors"""

    DEFAULT = White1
    HIGHLIGHTED = White3


# ------------------------------------------------------------------------------------------------------------------------


class PadMode(Enum):
    """Pad Modes"""

    OMNI = 0
    KEYBOARD = 1
    CHORDS = 2
    STEP = 3


class FourDEncoderMode(Enum):
    """4D Encoder Modes"""

    JOG = 0
    VOLUME = 1
    SWING = 2
    TEMPO = 3


def _get_channel_color(
    channel: int,
    highlighted: bool,
) -> int:
    """
    Return the LED color for a channel or plugin pad.

    Args:
        channel: Channel index to test for plugin validity.
        highlighted: Whether the pad should use the highlighted color.

    Returns:
        MIDI color value for the pad LED.
    """
    color = PluginColors if plugins.isValid(channel) else ChannelColors
    return color.HIGHLIGHTED.value if highlighted else color.DEFAULT.value  # type: ignore[attr-defined]


def _midi_out_msg_note_on(
    note: int,
    velocity: int,
    channel: int = 0,
) -> None:
    """
    Send a MIDI NOTE ON (144) message to the device.

    This is a thin wrapper around `device.midiOutMsg` that sends a NOTE ON
    message on the specified MIDI channel. A velocity of 0 is treated by
    MIDI devices as NOTE OFF.

    Args:
        note (int): MIDI note number (0–127).
        velocity (int): Note velocity (0–127). A value of 0 acts as NOTE OFF.
        channel (int, optional): MIDI channel (0–15). Defaults to 0.

    Returns:
        None
    """
    device.midiOutMsg(
        midi.MIDI_NOTEON,
        channel,
        note,
        velocity,
    )


def _midi_out_msg_control_change(
    control: int,
    value: int,
    channel: int = 0,
) -> None:
    """
    Send a MIDI CONTROL CHANGE (CC) (176) message to the device.

    This is a thin wrapper around `device.midiOutMsg` that sends a Control
    Change message on the specified MIDI channel.

    Args:
        control (int): MIDI controller number (0–127).
        value (int): Controller value (0–127).
        channel (int, optional): MIDI channel (0–15). Defaults to 0.

    Returns:
        None
    """
    device.midiOutMsg(
        midi.MIDI_CONTROLCHANGE,
        channel,
        control,
        value,
    )


def _on_off(condition: bool) -> int:
    """Helper to convert boolean to MIDI on/off value
    Args:
        condition (bool): Condition to evaluate
    Returns:
        int: 127 if condition is True, else 0
    """
    return 127 if condition else 0


class Controller:
    """Represents the state of the Maschine MK3 controller"""

    _channel_page: int
    """Current channel page (0-15) for channel rack pad display"""

    _plugin_picker_active: bool
    """Indicates whether the plugin picker is currently active"""

    def __init__(self):
        self._channel_page = 0
        self._plugin_picker_active = False

    def OnInit(self) -> None:
        self._init_led_states()
        self._sync_led_states()
        self._sync_channel_rack_controls()
        self._sync_mixer_controls()

    def OnDeInit(self) -> None:
        self._deinit_led_states()

    def OnRefresh(self, flags: int) -> None:
        print(f"flags: {flags}")
        if flags & midi.HW_Dirty_Mixer_Sel:
            print("flags & midi.HW_Dirty_Mixer_Sel")
        if flags & midi.HW_Dirty_Mixer_Display:
            print("midi.HW_Dirty_Mixer_Display")
        if flags & midi.HW_Dirty_Mixer_Controls:
            print("midi.HW_Dirty_Mixer_Controls")
        if flags & midi.HW_Dirty_FocusedWindow:
            print("midi.HW_Dirty_FocusedWindow")
        if flags & midi.HW_Dirty_Performance:
            print("midi.HW_Dirty_Performance")
        if flags & midi.HW_Dirty_LEDs:
            print("midi.HW_Dirty_LEDs")
            self._sync_led_states()
        if flags & midi.HW_Dirty_Patterns:
            print("midi.HW_Dirty_Patterns")
        if flags & midi.HW_Dirty_Tracks:
            print("midi.HW_Dirty_Tracks")
        if flags & midi.HW_Dirty_ControlValues:
            print("midi.HW_Dirty_ControlValues")
            if not self._plugin_picker_active:
                self._sync_channel_rack_controls()
        if flags & midi.HW_Dirty_Colors:
            print("midi.HW_Dirty_Colors")
        if flags & midi.HW_Dirty_Names:
            print("midi.HW_Dirty_Names")
        if flags & midi.HW_Dirty_ChannelRackGroup:
            print("midi.HW_Dirty_ChannelRackGroup")
        if flags & midi.HW_ChannelEvent:
            print("midi.HW_ChannelEvent")
            self._sync_channel_rack_pads()
            if not self._plugin_picker_active:
                self._sync_channel_rack_controls()

    def _init_led_states(self) -> None:
        self._deinit_led_states()

        for i in range(30, 34):
            _midi_out_msg_control_change(i, Green3)

        # fmt: off
        _midi_out_msg_control_change(CC_TOUCH_STRIP, int(transport.getSongPos() * 127))
        _midi_out_msg_control_change(CC_PAD_GROUP_A, White1)
        _midi_out_msg_control_change(CC_PAD_MODE, 127)
        _midi_out_msg_control_change(CC_FIX_VEL, 100)
        # fmt: on

    @staticmethod
    def _deinit_led_states() -> None:
        """De-initializes the LED states on the Maschine MK3 device"""
        for i in range(127):
            _midi_out_msg_control_change(i, Black0)
            _midi_out_msg_note_on(i, Black0)

    def _sync_led_states(self) -> None:
        """Syncs the LED states with the current FL Studio state"""

        # fmt: off
        _midi_out_msg_control_change(CC_CHANNEL,  _on_off(ui.getVisible(midi.widChannelRack)))
        _midi_out_msg_control_change(CC_ARRANGER, _on_off(ui.getVisible(midi.widPlaylist)))
        _midi_out_msg_control_change(CC_MIXER,    _on_off(ui.getVisible(midi.widMixer)))
        _midi_out_msg_control_change(CC_SAMPLING, _on_off(ui.getVisible(midi.widBrowser)))
        _midi_out_msg_control_change(CC_PLAY,     _on_off(transport.isPlaying()))
        _midi_out_msg_control_change(CC_REC,      _on_off(transport.isRecording()))
        _midi_out_msg_control_change(CC_FOLLOW,   _on_off(ui.isMetronomeEnabled()))
        _midi_out_msg_control_change(CC_STOP,     _on_off(not transport.isPlaying()))
        _midi_out_msg_control_change(CC_LOOP,     _on_off(bool(transport.getLoopMode())))
        _midi_out_msg_control_change(CC_LOCK,     _on_off(ui.getSnapMode() != 3))
        # fmt: on

        self._sync_channel_rack_pads()

    def _sync_channel_rack_pads(self) -> None:
        """Syncs the channel rack state with the pad LEDs on the Maschine MK3 device"""

        # NOTE: Need to check range later
        for i in range(127):
            _midi_out_msg_note_on(i, Black0)

        lower_channel = self._channel_page * 16
        channel_count = channels.channelCount()
        selected_channel = channels.selectedChannel()

        # turn on pads for available channels
        for channel in range(lower_channel, channel_count):
            idx = channel - lower_channel
            if idx == 16:
                break
            _midi_out_msg_note_on(idx, _get_channel_color(channel, False))

        # highlight selected channel pad
        if selected_channel in range(lower_channel, channel_count):
            channel = selected_channel - lower_channel
            _midi_out_msg_note_on(channel, _get_channel_color(channel, True))

    @staticmethod
    def _sync_channel_rack_controls() -> None:
        """Syncs the channel rack controls on the Maschine MK3 device with the current FL Studio channel rack state"""

        selected_channel = channels.selectedChannel()

        # fmt: off
        _midi_out_msg_control_change(CC_CHAN_SEL, selected_channel)
        _midi_out_msg_control_change(CC_CHAN_VOL, round(channels.getChannelVolume(selected_channel) * 100))
        _midi_out_msg_control_change(CC_CHAN_PAN, round((channels.getChannelPan(selected_channel) * 50) + 50))
        # fmt: on

    @staticmethod
    def _sync_mixer_controls() -> None:
        """Syncs the mixer (encoders) values on the Maschine MK3 device with the current FL Studio mixer state"""

        track_number = mixer.trackNumber()

        # fmt: off
        _midi_out_msg_control_change(CC_MIX_TRACK, track_number)
        _midi_out_msg_control_change(CC_MIX_VOLUME, round(mixer.getTrackVolume(track_number) * 125))
        _midi_out_msg_control_change(CC_MIX_PAN, round((mixer.getTrackPan(track_number) * 50) + 50))
        _midi_out_msg_control_change(CC_MIX_STEREO, round((mixer.getTrackStereoSep(track_number) + 1) * 50))
        # fmt: on


controller = Controller()


def OnInit() -> None:
    """
    Called when FL Studio initializes the script.

    Note that the script may be kept in memory after being de-initialized with OnDeInit(),
    so this function may be called more than once during the lifetime of this Python script.
    """
    controller.OnInit()


def OnDeInit() -> None:
    """
    Called before FL Studio de-initializes the script.

    This function should be used to shut down the attached device
    """
    controller.OnDeInit()


def OnRefresh(flags: int) -> None:
    """
    Called when certain events occur within FL Studio. Scripts should use the provided flags to update required interfaces on their associated controllers.
    flags values will be a bitwise combination of the OnRefresh flags.

    Args:
        flags (int): flags to represent the changes in FL Studio's state.
    """
    controller.OnRefresh(flags)
