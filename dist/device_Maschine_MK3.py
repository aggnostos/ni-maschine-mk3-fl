# name=NI Maschine MK3


# ------------------------------------------------------------------------- #
#  THIS FILE IS AUTO-GENERATED                                              #
#  DO NOT EDIT THIS FILE MANUALLY.                                          #
#                                                                           #
#  Any changes made to this file will be overwritten.                       #
# ------------------------------------------------------------------------- #


from enum import IntEnum
import midi
import device
import plugins
import ui
import mixer
import general
import patterns
import channels
import transport


class CC(IntEnum):
    CHANNEL = 34
    PLUGIN = 35
    ARRANGER = 36
    MIXER = 37
    BROWSER = 38
    FILE_SAVE = 40
    SETTINGS = 41
    ENCODER_PUSH = 7
    ENCODER_TURN = 8
    ENCODER_UP = 30
    ENCODER_RIGHT = 31
    ENCODER_DOWN = 32
    ENCODER_LEFT = 33
    ENCODER_VOLUME = 44
    ENCODER_SWING = 45
    ENCODER_TEMPO = 47
    TOUCH_STRIP = 1
    TOUCH_STRIP_PITCH = 49
    TOUCH_STRIP_MOD = 50
    TOUCH_STRIP_PERFORM = 51
    TOUCH_STRIP_NOTES = 52
    GROUP_A = 100
    GROUP_B = 101
    GROUP_C = 102
    GROUP_D = 103
    GROUP_E = 104
    GROUP_F = 105
    GROUP_G = 106
    GROUP_H = 107
    RESTART = 53
    ERASE = 54
    TAP = 55
    PLAY = 57
    GRID = 56
    REC = 58
    STOP = 59
    FIXED_VEL = 81
    PAD_MODE = 80
    KEYBOARD_MODE = 82
    CHORDS_MODE = 84
    STEP_MODE = 83
    PATTERN = 86
    SELECT = 90
    SOLO = 91
    MUTE = 92
    PRESET_NEXT = 22
    PRESET_PREV = 23
    OCTAVE_DOWN = 26
    OCTAVE_UP = 27
    SEMI_DOWN = 28
    SEMI_UP = 29
    MIX_TRACK = 70
    MIX_VOL = 71
    MIX_PAN = 72
    MIX_SS = 73
    CHAN_SEL = 74
    CHAN_VOL = 75
    CHAN_PAN = 76
    FIX_VEL = 77
    SHIFT = 46


class ControllerColor(IntEnum):
    BLACK_0 = 0
    BLACK_1 = 1
    BLACK_2 = 2
    BLACK_3 = 3
    RED_0 = 4
    RED_1 = 5
    RED_2 = 6
    RED_3 = 7
    ORANGE_0 = 8
    ORANGE_1 = 9
    ORANGE_2 = 10
    ORANGE_3 = 11
    LIGHT_ORANGE_0 = 12
    LIGHT_ORANGE_1 = 13
    LIGHT_ORANGE_2 = 14
    LIGHT_ORANGE_3 = 15
    WARM_YELLOW_0 = 16
    WARM_YELLOW_1 = 17
    WARM_YELLOW_2 = 18
    WARM_YELLOW_3 = 19
    YELLOW_0 = 20
    YELLOW_1 = 21
    YELLOW_2 = 22
    YELLOW_3 = 23
    LIME_0 = 24
    LIME_1 = 25
    LIME_2 = 26
    LIME_3 = 27
    GREEN_0 = 28
    GREEN_1 = 29
    GREEN_2 = 30
    GREEN_3 = 31
    MINT_0 = 32
    MINT_1 = 33
    MINT_2 = 34
    MINT_3 = 35
    CYAN_0 = 36
    CYAN_1 = 37
    CYAN_2 = 38
    CYAN_3 = 39
    TURQUOISE_0 = 40
    TURQUOISE_1 = 41
    TURQUOISE_2 = 42
    TURQUOISE_3 = 43
    BLUE_0 = 44
    BLUE_1 = 45
    BLUE_2 = 46
    BLUE_3 = 47
    PLUM_0 = 48
    PLUM_1 = 49
    PLUM_2 = 50
    PLUM_3 = 51
    VIOLET_0 = 52
    VIOLET_1 = 53
    VIOLET_2 = 54
    VIOLET_3 = 55
    PURPLE_0 = 56
    PURPLE_1 = 57
    PURPLE_2 = 58
    PURPLE_3 = 59
    MAGENTA_0 = 60
    MAGENTA_1 = 61
    MAGENTA_2 = 62
    MAGENTA_3 = 63
    FUCHSIA_0 = 64
    FUCHSIA_1 = 65
    FUCHSIA_2 = 66
    FUCHSIA_3 = 67
    WHITE_0 = 68
    WHITE_1 = 69
    WHITE_2 = 70
    WHITE_3 = 71


class PluginColor(IntEnum):
    DEFAULT = 8
    HIGHLIGHTED = 10


class ChannelColor(IntEnum):
    DEFAULT = 68
    HIGHLIGHTED = 70


class PadMode(IntEnum):
    OMNI = 0
    KEYBOARD = 1
    CHORDS = 2
    STEP = 3


class PadModeColor(IntEnum):
    OMNI = 10
    KEYBOARD = 46
    CHORDS = 6
    STEP = 58


class FourDEncoderMode(IntEnum):
    JOG = 0
    VOLUME = 1
    SWING = 2
    TEMPO = 3


class TouchStripMode(IntEnum):
    TRANSPORT = 0
    PITCH = 1
    MOD = 2
    PERFORM = 3
    NOTES = 4


class PadGroup(IntEnum):
    A = 100
    B = 101
    C = 102
    D = 103
    E = 104
    F = 105
    G = 106
    H = 107


def _get_channel_color(channel: int, highlighted: bool) -> int:
    color = PluginColor if plugins.isValid(channel) else ChannelColor
    return color.HIGHLIGHTED.value if highlighted else color.DEFAULT.value


def _midi_out_msg_note_on(note: int, velocity: int, channel: int = 0) -> None:
    device.midiOutMsg(midi.MIDI_NOTEON, channel, note, velocity)


def _midi_out_msg_control_change(control: int, value: int, channel: int = 0) -> None:
    device.midiOutMsg(midi.MIDI_CONTROLCHANGE, channel, control, value)


def _on_off(condition: bool) -> int:
    return 127 if condition else 0


def _percent_to_bipolar(percent: int) -> float:
    return percent / 50.0 - 1.0


def _bipolar_to_percent(bipolar: float) -> int:
    return round((bipolar + 1.0) * 50)


class Controller:
    _pad_mode: PadMode
    "Current pad mode. See PadMode Enum"
    _pad_mode_color: PadModeColor
    "Current pad mode color. See PadModeColor Enum"
    _encoder_mode: FourDEncoderMode
    "Current 4D encoder mode. See FourDEncoderMode Enum"
    _touch_strip_mode: TouchStripMode
    "Current touch strip mode. See TouchStripMode Enum"
    _active_group: PadGroup
    "Current selected group (A-H)"
    _selected_channel: int
    "Currently selected channel index"
    _channel_page: int
    "Current channel page (0-15) for OMNI mode pad display"
    _step_page: int
    "Current step sequence page (0-15) for STEP mode pad display"
    _semi_offset: int
    "Current semitone offset"
    _scale_index: int
    "Current scale index for keyboard mode (0-7)"
    _chordset_index: int
    "Current chord set index for chords mode (0-7)"
    _fixed_velocity: int
    "Fixed velocity value for pads when fixed velocity mode is enabled"
    _is_fixed_velocity: bool
    "Indicates whether fixed velocity mode is enabled"
    _shifting: bool
    "Indicates whether the shift button is currently pressed"
    _is_plugin_picker_active: bool
    "Indicates whether the plugin picker is currently active"
    _is_selecting_pattern: bool
    "Indicates whether the user is currently selecting a pattern"
    _is_selecting_channel: bool
    "Indicates whether the user is currently selecting a channel"

    def __init__(self):
        self._pad_mode = 0
        self._pad_mode_color = 10
        self._encoder_mode = 0
        self._touch_strip_mode = 0
        self._active_group = 100
        self._selected_channel = 0
        self._channel_page = 0
        self._step_page = 0
        self._semi_offset = 0
        self._scale_index = 0
        self._chordset_index = 0
        self._fixed_velocity = 100
        self._is_fixed_velocity = False
        self._shifting = False
        self._is_plugin_picker_active = False
        self._is_selecting_pattern = False
        self._is_selecting_channel = False

    def on_init(self) -> None:
        self._init_led_states()
        self._sync_cc_led_states()
        self._sync_selected_channel()
        self._sync_channel_pads()
        self._sync_channel_controls()
        self._sync_mixer_controls()
        self._sync_song_position()

    def on_de_init(self) -> None:
        self._deinit_led_states()

    def on_refresh(self, flags: int) -> None:
        channel_event = flags & midi.HW_ChannelEvent
        pattern_event = flags & midi.HW_Dirty_Patterns
        control_values_event = flags & midi.HW_Dirty_ControlValues
        mixer_sel_event = flags & midi.HW_Dirty_Mixer_Sel
        mixer_display_event = flags & midi.HW_Dirty_Mixer_Display
        mixer_controls_event = flags & midi.HW_Dirty_Mixer_Controls
        leds_event = flags & midi.HW_Dirty_LEDs
        if channel_event:
            self._sync_selected_channel()
            if not self._is_plugin_picker_active:
                self._sync_channel_controls()
            if not self._is_plugin_picker_active:
                self._sync_channel_pads()
        elif mixer_sel_event or mixer_display_event or mixer_controls_event:
            if not self._is_plugin_picker_active:
                self._sync_mixer_controls()
        elif leds_event:
            self._sync_cc_led_states()
            if self._touch_strip_mode == 0:
                self._sync_song_position()
            if not self._is_selecting_pattern:
                self._sync_channel_pads()
        if mixer_controls_event and leds_event:
            _midi_out_msg_control_change(58, _on_off(transport.isRecording()))
        if pattern_event:
            if self._is_selecting_pattern:
                self._sync_patterns()
            if not self._is_selecting_pattern:
                self._sync_channel_pads()
        if control_values_event:
            if self._touch_strip_mode == 1:
                self._sync_touch_strip_value(self._touch_strip_mode)
            if not self._is_plugin_picker_active:
                self._sync_channel_controls()

    def on_control_change(self, msg) -> None:
        cc_num, cc_val = (msg.controlNum, msg.controlVal)
        match cc_num:
            case 34:
                if ui.getVisible(midi.widChannelRack):
                    ui.hideWindow(midi.widChannelRack)
                else:
                    ui.showWindow(midi.widChannelRack)
            case 35:
                channels.showCSForm(self._selected_channel, -1)
            case 36:
                if ui.getVisible(midi.widPlaylist):
                    ui.hideWindow(midi.widPlaylist)
                else:
                    ui.showWindow(midi.widPlaylist)
            case 37:
                if ui.getVisible(midi.widMixer):
                    ui.hideWindow(midi.widMixer)
                else:
                    ui.showWindow(midi.widMixer)
            case 38 if self._shifting:
                self._is_plugin_picker_active = not self._is_plugin_picker_active
                transport.globalTransport(midi.FPT_F8, 1)
            case 38:
                if ui.getVisible(midi.widBrowser):
                    ui.hideWindow(midi.widBrowser)
                else:
                    ui.showWindow(midi.widBrowser)
            case 40:
                transport.globalTransport(midi.FPT_Save, 1)
            case 41:
                transport.globalTransport(midi.FPT_F10, 1)
            case 7:
                ui.enter()
            case 8:
                is_clockwise = cc_val == 65
                multiplier = 1 if is_clockwise else -1
                track_number = mixer.trackNumber()
                match self._encoder_mode:
                    case 0:
                        ui.jog(1 * multiplier)
                    case 1:
                        if ui.getFocused(midi.widMixer):
                            target_vol = (
                                mixer.getTrackVolume(track_number)
                                + 0.012125 * multiplier
                            )
                            if 0.0 < target_vol < 1.0:
                                mixer.setTrackVolume(track_number, target_vol)
                        elif ui.getFocused(midi.widChannelRack):
                            channels.setChannelVolume(
                                self._selected_channel,
                                channels.getChannelVolume(self._selected_channel)
                                + 0.03125 * multiplier,
                            )
                    case 2:
                        swing = general.processRECEvent(
                            midi.REC_MainShuffle, 0, midi.REC_GetValue
                        )
                        target_swing = swing + 1 * multiplier
                        if 0 <= target_swing <= 128:
                            general.processRECEvent(
                                midi.REC_MainShuffle,
                                target_swing,
                                midi.REC_UpdateControl | midi.REC_Control,
                            )
                    case 3:
                        transport.globalTransport(midi.FPT_TempoJog, 10 * multiplier)
            case 30:
                ui.up()
            case 31:
                ui.right()
            case 32:
                ui.down()
            case 33:
                ui.left()
            case 44 | 45 | 47:
                self._toggle_encoder_mode(cc_num)
            case 1:
                match self._touch_strip_mode:
                    case 0:
                        transport.setSongPos(cc_val / 100)
                        _midi_out_msg_control_change(1, cc_val)
                    case 1:
                        channels.setChannelPitch(
                            self._selected_channel, _percent_to_bipolar(cc_val)
                        )
                    case 2:
                        pass
                    case 3:
                        pass
                    case 4:
                        pass
            case 49 | 50 | 51 | 52:
                self._toggle_touch_strip_mode(cc_num)
                self._sync_touch_strip_value(self._touch_strip_mode)
            case 100 | 101 | 102 | 103 | 104 | 105 | 106 | 107:
                page_idx = cc_num - 100
                match self._pad_mode:
                    case 0:
                        self._channel_page = page_idx
                    case 1:
                        self._scale_index = page_idx
                    case 2:
                        self._chordset_index = page_idx
                    case 3:
                        self._step_page = page_idx
                    case _:
                        return
                self._active_group = PadGroup(cc_num)
                self._change_group_colors()
                self._sync_channel_pads()
            case 53 if self._shifting:
                transport.setLoopMode()
            case 53:
                transport.stop()
                transport.start()
            case 54:
                ui.delete()
            case 55 if self._shifting:
                transport.globalTransport(midi.FPT_Metronome, 1)
            case 55:
                if cc_val:
                    transport.globalTransport(midi.FPT_TapTempo, 1)
            case 56:
                ui.snapOnOff()
            case 57:
                transport.start()
            case 59:
                transport.stop()
            case 58 if self._shifting:
                transport.globalTransport(midi.FPT_CountDown, 1)
            case 58:
                transport.record()
            case 81:
                self._is_fixed_velocity = bool(cc_val)
            case 80 | 82 | 84 | 83:
                for cc in (80, 82, 84, 83):
                    _midi_out_msg_control_change(cc, 127 if cc == cc_num else 0)
                active_group = 100
                match cc_num:
                    case 80:
                        self._pad_mode = 0
                        self._pad_mode_color = 10
                        active_group += self._channel_page
                    case 82:
                        self._pad_mode = 1
                        self._pad_mode_color = 46
                        active_group += self._scale_index
                    case 84:
                        self._pad_mode = 2
                        self._pad_mode_color = 6
                        active_group += self._chordset_index
                    case 83:
                        self._pad_mode = 3
                        self._pad_mode_color = 58
                        active_group += self._step_page
                    case _:
                        pass
                self._active_group = PadGroup(active_group)
                self._change_group_colors()
                self._sync_channel_pads()
            case 86:
                for p in range(16):
                    _midi_out_msg_note_on(p, 0)
                self._is_selecting_pattern = bool(cc_val)
                if cc_val:
                    self._sync_patterns()
                elif self._pad_mode in (0, 3):
                    self._sync_channel_pads()
            case 90:
                self._is_selecting_channel = bool(cc_val)
                self._sync_channel_pads()
            case 91:
                if ui.getFocused(midi.widChannelRack):
                    channels.soloChannel(self._selected_channel)
                elif ui.getFocused(midi.widMixer):
                    if self._shifting:
                        mixer.soloTrack(
                            mixer.trackNumber(), -1, midi.fxSoloModeWithSourceTracks
                        )
                    else:
                        mixer.soloTrack(
                            mixer.trackNumber(), -1, midi.fxSoloModeWithDestTracks
                        )
            case 92:
                if ui.getFocused(midi.widChannelRack):
                    channels.muteChannel(self._selected_channel)
                elif ui.getFocused(midi.widMixer):
                    mixer.muteTrack(mixer.trackNumber())
            case 22 | 23:
                if not plugins.isValid(self._selected_channel):
                    return
                if cc_num == 22:
                    plugins.nextPreset(self._selected_channel)
                else:
                    plugins.prevPreset(self._selected_channel)
            case 26 if self._semi_offset > 12 * -5:
                self._semi_offset -= 12
            case 27 if self._semi_offset < 12 * 5:
                self._semi_offset += 12
            case 28 if self._semi_offset > 12 * -5:
                self._semi_offset -= 1
            case 29 if self._semi_offset < 12 * 5:
                self._semi_offset += 1
            case 70:
                mixer.setTrackNumber(cc_val)
            case 71:
                mixer.setTrackVolume(mixer.trackNumber(), cc_val / 125)
            case 72:
                mixer.setTrackPan(mixer.trackNumber(), _percent_to_bipolar(cc_val))
            case 73:
                mixer.setTrackStereoSep(
                    mixer.trackNumber(), _percent_to_bipolar(cc_val)
                )
            case 74:
                if cc_val < channels.channelCount():
                    channels.selectOneChannel(cc_val)
                else:
                    _midi_out_msg_control_change(74, self._selected_channel)
            case 75:
                channels.setChannelVolume(self._selected_channel, cc_val / 100)
            case 76:
                channels.setChannelPan(
                    self._selected_channel, _percent_to_bipolar(cc_val)
                )
            case 77:
                self._fixed_velocity = cc_val
            case 46:
                self._shifting = bool(cc_val)
            case _:
                return
        msg.handled = True

    def on_note_on(self, msg) -> None:
        note_num, note_vel = (msg.note, msg.velocity)
        if note_vel:
            if self._shifting:
                if note_num == 0:
                    general.undoUp()
                elif note_num == 1:
                    general.undoDown()
                msg.handled = True
            if self._is_selecting_pattern:
                patterns.jumpToPattern(note_num + 1)
                self._sync_patterns()
                msg.handled = True
            if self._is_selecting_channel:
                chan_idx = note_num + self._channel_page * 16
                if chan_idx < channels.channelCount():
                    channels.selectOneChannel(chan_idx)
                msg.handled = True
        if msg.handled or self._is_selecting_pattern or self._is_selecting_channel:
            return
        match self._pad_mode:
            case 0:
                real_note = 48 + self._get_semi_offset()
                chan_idx = note_num + self._channel_page * 16
                if chan_idx >= channels.channelCount():
                    return
                if note_vel:
                    channels.midiNoteOn(
                        chan_idx,
                        real_note,
                        self._fixed_velocity if self._is_fixed_velocity else note_vel,
                    )
                else:
                    channels.midiNoteOn(chan_idx, real_note, 0)
                _midi_out_msg_note_on(
                    note_num, _get_channel_color(chan_idx, bool(note_vel))
                )
            case 1:
                real_note = [
                    [36, 38, 44, 46, 37, 40, 45, 41, 47, 42, 39, 43, 48, 49, 50, 55],
                    [48, 50, 51, 53, 55, 56, 58, 60, 62, 63, 65, 67, 68, 70, 72, 74],
                    [48, 50, 52, 53, 55, 57, 59, 60, 62, 64, 65, 67, 69, 71, 72, 74],
                    [37, 36, 42, 82, 40, 38, 46, 44, 48, 47, 45, 43, 49, 55, 51, 53],
                    [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63],
                    [48, 49, 52, 53, 55, 56, 59, 60, 61, 64, 65, 67, 68, 71, 72, 73],
                    [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63],
                    [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63],
                ][self._scale_index][note_num] + self._get_semi_offset()
                if note_vel:
                    channels.midiNoteOn(
                        self._selected_channel,
                        real_note,
                        self._fixed_velocity if self._is_fixed_velocity else note_vel,
                    )
                    _midi_out_msg_note_on(note_num, 46)
                else:
                    channels.midiNoteOn(self._selected_channel, real_note, 0)
                    _midi_out_msg_note_on(note_num, 0)
            case 2:
                chord_notes = [
                    [
                        [36, 48, 51, 55],
                        [39, 48, 51, 55],
                        [41, 36, 53, 56],
                        [31, 47, 50, 55],
                        [32, 48, 51, 55],
                        [39, 46, 51, 55],
                        [31, 46, 50, 55],
                        [34, 46, 50, 53],
                        [29, 45, 48, 53],
                        [32, 48, 53, 56],
                        [31, 48, 51, 55],
                        [31, 47, 50, 55],
                        [29, 38, 53, 56],
                        [38, 50, 53, 58],
                        [38, 48, 50, 55],
                        [36, 48, 53, 55],
                    ],
                    [
                        [36, 43, 48, 51],
                        [35, 43, 47, 51],
                        [34, 43, 48, 51],
                        [31, 47, 50, 55],
                        [32, 48, 51, 55],
                        [39, 46, 51, 55],
                        [31, 46, 50, 55],
                        [34, 46, 50, 53],
                        [29, 45, 48, 53],
                        [32, 48, 53, 56],
                        [31, 48, 51, 55],
                        [31, 47, 50, 55],
                        [36, 48, 51, 55],
                        [29, 38, 53, 56],
                        [34, 38, 53, 58],
                        [34, 38, 50, 55],
                    ],
                    [
                        [36, 43, 48, 50, 55],
                        [36, 43, 46, 50, 53],
                        [38, 45, 48, 50, 53],
                        [38, 57, 48, 52, 55],
                        [40, 43, 48, 50, 55],
                        [38, 43, 46, 50, 53],
                        [33, 45, 48, 50, 53],
                        [33, 45, 48, 52, 55],
                        [39, 51, 54, 58],
                        [39, 49, 53, 56],
                        [37, 49, 53, 56],
                        [39, 53, 56, 61],
                        [37, 53, 56, 61],
                        [36, 51, 56, 60],
                        [36, 51, 55, 58],
                        [34, 38, 55, 58],
                    ],
                    [
                        [25, 38, 43, 46],
                        [29, 36, 41, 45],
                        [31, 38, 43, 46],
                        [34, 41, 46, 50],
                        [26, 33, 38, 41],
                        [24, 31, 36, 39],
                        [29, 36, 41, 45],
                        [31, 38, 43, 46],
                        [36, 48, 51, 55],
                        [36, 48, 51, 55],
                        [36, 48, 51, 55],
                        [36, 48, 51, 55],
                        [36, 48, 51, 55],
                        [36, 48, 51, 55],
                        [36, 48, 51, 55],
                        [36, 48, 51, 55],
                    ],
                    [
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                    ],
                    [
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                    ],
                    [
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                    ],
                    [
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                        [36, 48, 52, 55],
                    ],
                ][self._chordset_index][note_num]
                for note in chord_notes:
                    real_note = note + self._get_semi_offset()
                    if note_vel:
                        channels.midiNoteOn(
                            self._selected_channel,
                            real_note,
                            (
                                self._fixed_velocity
                                if self._is_fixed_velocity
                                else note_vel
                            ),
                        )
                        _midi_out_msg_note_on(note_num, 6)
                    else:
                        channels.midiNoteOn(self._selected_channel, real_note, 0)
                        _midi_out_msg_note_on(note_num, 0)
            case 3 if note_vel:
                chan_idx = note_num + self._step_page * 16
                selected_channel = self._selected_channel
                channels.setGridBit(
                    selected_channel,
                    chan_idx,
                    not channels.getGridBit(selected_channel, chan_idx),
                )
            case _:
                return
        msg.handled = True

    def _init_led_states(self) -> None:
        self._deinit_led_states()
        _midi_out_msg_control_change(100, self._pad_mode_color)
        _midi_out_msg_control_change(80, 127)
        _midi_out_msg_control_change(77, 100)

    @staticmethod
    def _deinit_led_states() -> None:
        for cc in range(128):
            _midi_out_msg_control_change(cc, 0)
        for note in range(16):
            _midi_out_msg_note_on(note, 0)

    def _sync_cc_led_states(self) -> None:
        _midi_out_msg_control_change(34, _on_off(ui.getVisible(midi.widChannelRack)))
        _midi_out_msg_control_change(36, _on_off(ui.getVisible(midi.widPlaylist)))
        _midi_out_msg_control_change(37, _on_off(ui.getVisible(midi.widMixer)))
        _midi_out_msg_control_change(53, _on_off(bool(transport.getLoopMode())))
        _midi_out_msg_control_change(38, _on_off(ui.getVisible(midi.widBrowser)))
        _midi_out_msg_control_change(55, _on_off(general.getUseMetronome()))
        _midi_out_msg_control_change(57, _on_off(transport.isPlaying()))
        _midi_out_msg_control_change(58, _on_off(transport.isRecording()))
        _midi_out_msg_control_change(59, _on_off(not transport.isPlaying()))
        _midi_out_msg_control_change(56, _on_off(ui.getSnapMode() != 3))

    def _sync_selected_channel(self) -> None:
        self._selected_channel = channels.selectedChannel()

    def _toggle_selected_channel_highlight(self) -> None:
        _midi_out_msg_note_on(
            self._selected_channel - self._channel_page * 16,
            _get_channel_color(self._selected_channel, self._is_selecting_channel),
        )

    def _sync_channel_pads(self) -> None:
        for note in range(16):
            _midi_out_msg_note_on(note, 0)
        if self._pad_mode == 0 or self._is_selecting_channel:
            lower_channel = self._channel_page * 16
            channel_count = channels.channelCount()
            for channel in range(lower_channel, channel_count):
                idx = channel - lower_channel
                if idx == 16:
                    break
                _midi_out_msg_note_on(idx, _get_channel_color(channel, False))
            self._toggle_selected_channel_highlight()
        elif self._pad_mode == 3:
            lower_step = self._step_page * 16
            for gridbit in range(lower_step, lower_step + 16):
                idx = gridbit - lower_step
                _midi_out_msg_note_on(
                    idx,
                    58 if channels.getGridBit(self._selected_channel, gridbit) else 0,
                )

    def _sync_channel_controls(self) -> None:
        _midi_out_msg_control_change(74, self._selected_channel)
        _midi_out_msg_control_change(
            75, round(channels.getChannelVolume(self._selected_channel) * 100)
        )
        _midi_out_msg_control_change(
            76, _bipolar_to_percent(channels.getChannelPan(self._selected_channel))
        )
        _midi_out_msg_control_change(
            91, _on_off(channels.isChannelSolo(self._selected_channel))
        )
        _midi_out_msg_control_change(
            92, _on_off(channels.isChannelMuted(self._selected_channel))
        )

    @staticmethod
    def _sync_mixer_controls() -> None:
        track_number = mixer.trackNumber()
        _midi_out_msg_control_change(70, track_number)
        _midi_out_msg_control_change(
            71, round(mixer.getTrackVolume(track_number) * 125)
        )
        _midi_out_msg_control_change(
            72, _bipolar_to_percent(mixer.getTrackPan(track_number))
        )
        _midi_out_msg_control_change(
            73, _bipolar_to_percent(mixer.getTrackStereoSep(track_number))
        )
        _midi_out_msg_control_change(91, _on_off(mixer.isTrackSolo(track_number)))
        _midi_out_msg_control_change(92, _on_off(mixer.isTrackMuted(track_number)))

    def _toggle_encoder_mode(self, cc: int) -> None:
        match cc:
            case 44:
                mode = 1
            case 45:
                mode = 2
            case 47:
                mode = 3
            case _:
                mode = 0
        mode = mode if self._encoder_mode != mode else 0
        for cc_num in (44, 45, 47):
            _midi_out_msg_control_change(
                cc_num, 127 if cc == cc_num and mode != 0 else 0
            )
        self._encoder_mode = mode

    def _toggle_touch_strip_mode(self, cc: int) -> None:
        match cc:
            case 49:
                mode = 1
            case 50:
                mode = 2
            case 51:
                mode = 3
            case 52:
                mode = 4
            case _:
                mode = 0
        mode = mode if self._touch_strip_mode != mode else 0
        for cc_num in (49, 50, 51, 52):
            _midi_out_msg_control_change(
                cc_num, 127 if cc == cc_num and mode != 0 else 0
            )
        self._touch_strip_mode = mode

    def _sync_touch_strip_value(self, mode: TouchStripMode) -> None:
        match mode:
            case 0:
                self._sync_song_position()
            case 1:
                _midi_out_msg_control_change(
                    1,
                    _bipolar_to_percent(
                        channels.getChannelPitch(self._selected_channel)
                    ),
                )
            case 2:
                pass
            case 3:
                pass
            case 4:
                pass

    def _sync_song_position(self) -> None:
        _midi_out_msg_control_change(1, int(transport.getSongPos() * 100))

    def _change_group_colors(self) -> None:
        for cc in range(100, 107 + 1):
            _midi_out_msg_control_change(
                cc, self._pad_mode_color if cc == self._active_group else 0
            )

    def _sync_patterns(self) -> None:
        for pattern in range(patterns.patternCount()):
            _midi_out_msg_note_on(
                pattern, 10 if patterns.isPatternSelected(pattern + 1) else 8
            )

    def _get_semi_offset(self) -> int:
        return self._semi_offset + 12


controller = Controller()


def OnInit() -> None:
    controller.on_init()


def OnDeInit() -> None:
    controller.on_de_init()


def OnRefresh(flags: int) -> None:
    controller.on_refresh(flags)


def OnControlChange(msg) -> None:
    controller.on_control_change(msg)


def OnNoteOn(msg) -> None:
    controller.on_note_on(msg)
